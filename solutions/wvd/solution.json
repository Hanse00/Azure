{
    "$schema": "https://schema.management.azure.com/schemas/2018-05-01/subscriptionDeploymentTemplate.json#",
    "contentVersion": "1.0.0.0",
    "parameters": {
        "AppGroupName": {
            "type": "string",
            "metadata": {
                "description": "The name of the WVD application group."
            },
            "defaultValue": "Desktops"
        },
        "AppGroupType": {
            "type": "string",
            "metadata": {
                "description": "The type of WVD application group."
            },
            "allowedValues": [
                "Desktop",
                "RemoteApp"
            ],
            "defaultValue": "Desktop"
        },
        "AvailabilitySetName": {
            "type": "string",
            "metadata": {
                "description": "The name for the Availability Set for the WVD Session Hosts."
            },
            "defaultValue": "as-wvd-poc-eus-"
        },
        "CustomRdpProperty": {
            "type": "string",
            "metadata": {
                "description": "Input RDP properties to add or remove RDP functionality on the host pool. Settings reference: https://docs.microsoft.com/en-us/windows-server/remote/remote-desktop-services/clients/rdp-files?context=/azure/virtual-desktop/context/context"
            },
            "defaultValue": "audiocapturemode:i:1;camerastoredirect:s:*;use multimon:i:0;drivestoredirect:s:;"
        },
        "DiskNamePrefix": {
            "type": "string",
            "metadata": {
                "description": "The name for the OS disk on the Session Hosts."
            },
            "defaultValue": "disk-wvd-poc-eus-"
        },
        "DiskSku": {
            "type": "string",
            "metadata": {
                "description": "Storage SKU for the WVD session host disks"
            },
            "allowedValues": [
                "Standard_LRS",
                "StandardSSD_LRS",
                "Premium_LRS"
            ],
            "defaultValue": "Premium_LRS"
        },
        "DomainAdminPassword": {
            "type": "securestring",
            "metadata": {
                "description": "Input your domain administrator password to join the WVD session hosts to your domain"
            }
        },
        "DomainAdminUsername": {
            "type": "string",
            "metadata": {
                "description": "Input your domain administrator username to join the WVD session hosts to your domain. Only the username is required. Do not add the Netbios value."
            }
        },
        "DomainControllerName": {
            "type": "string",
            "metadata": {
                "description": "Name of an Azure Domain Controller for joining the Azure Storage Account to the domain"
            },
            "defaultValue": "vm-dc-d-eus-0"
        },
        "DomainControllerResourceGroupName": {
            "type": "string",
            "metadata": {
                "description": "Name of an Azure Domain Controller for joining the Azure Storage Account to the domain"
            },
            "defaultValue": "rg-identity-d-eastus"
        },
        "DomainName": {
            "type": "string",
            "metadata": {
                "description": "Name of the domain that provides ADDS to the WVD session hosts and is synchronized with Azure AD"
            },
            "defaultValue": "jasonmasten.com"
        },
        "FileShareQuota": {
            "type": "int",
            "metadata": {
                "description": "The file share quota for the file share on the Azure Storage Account."
            },
            "defaultValue": 100
        },
        "HostPoolName": {
            "type": "string",
            "metadata": {
                "description": "The name for the WVD Host Pool."
            },
            "defaultValue": "hp-wvd-poc-eus-000"
        },
        "HostPoolType": {
            "type": "string",
            "metadata": {
                "description": "These options specify the host pool type and depending on the type, provides the load balancing options and assignment types."
            },
            "allowedValues": [
                "Pooled DepthFirst",
                "Pooled BreadthFirst",
                "Personal Automatic",
                "Personal Direct"
            ],
            "defaultValue": "Pooled DepthFirst"
        },
        "ImageOffer": {
            "type": "string",
            "metadata": {
                "description": "Offer for the virtual machine image"
            },
            "defaultValue": "office-365"
        },
        "ImagePublisher": {
            "type": "string",
            "metadata": {
                "description": "Publisher for the virtual machine image"
            },
            "defaultValue": "MicrosoftWindowsDesktop"
        },
        "ImageSku": {
            "type": "string",
            "metadata": {
                "description": "SKU for the virtual machine image"
            },
            "defaultValue": "20h2-evd-o365pp"
        },
        "ImageVersion": {
            "type": "string",
            "metadata": {
                "description": "Version for the virtual machine image"
            },
            "defaultValue": "latest"
        },
        "KerberosEncryptionType": {
            "type": "string",
            "metadata": {
                "description": "Active Directory Computer Object Kerberos Encryption Type"
            },
            "allowedValues": [
                "RC4",
                "AES256"
            ],
            "defaultValue": "RC4"
        },
        "Location": {
            "type": "string",
            "metadata": {
                "description": "Deployment location for all resources"
            },
            "defaultValue": "[deployment().location]"
        },
        "MaxSessionLimit": {
            "type": "int",
            "metadata": {
                "description": "The maximum number of sessions per WVD session host"
            },
            "defaultValue": 2
        },
        "newOrExisting": {
            "type": "string",
            "allowedValues": [
                "new",
                "existing"
            ]
        },
        "NicNamePrefix": {
            "type": "string",
            "metadata": {
                "description": "The Name Prefix for the Network Interfaces on the Session Hosts.  During deployment a 3 digit number will be added to each NIC to complete the name."
            },
            "defaultValue": "nic-wvd-poc-eus-"
        },
        "Optimizations": {
            "type": "string",
            "metadata": {
                "description": "WVD Optimizations to implement on the Session Hosts using the optimization script. Input a string array with any of the following values: 'All','WindowsMediaPlayer','AppxPackages','ScheduledTasks','DefaultUserSettings','Autologgers','Services','NetworkOptimizations','LGPO','DiskCleanup'"
            },
            "defaultValue": "All"
        },
        "OuPath": {
            "type": "string",
            "metadata": {
                "description": "Distinguished name for the target Organization Unit in Active Directory Domain Services."
            },
            "defaultValue": ""
        },
        "PreferredAppGroupType": {
            "type": "string",
            "metadata": {
                "description": "The type of preferred application group type.  The default is Desktop which creates 'Desktop Application Group'"
            },
            "allowedValues": [
                "Desktop",
                "RailApplications"
            ],
            "defaultValue": "Desktop"
        },
        "ResourceGroups": {
            "type": "array",
            "metadata": {
                "description": "The Names of the resource groups for the WVD Host Pool and Session Hosts."
            },
            "defaultValue": [
                "rg-wvd-poc-infra-eus-000",
                "rg-wvd-poc-hosts-eus-000"
            ]
        },
        "SecurityPrincipalId": {
            "type": "string",
            "metadata": {
                "description": "The Object ID for the Security Principal to assign to the WVD Application Group.  This Security Principal will be assigned the Desktop Virtualization User role on the Application Group."
            },
            "defaultValue": "5c55bf93-86ee-4e1d-a81a-3a78402e6077"
        },
        "SecurityPrincipalName": {
            "type": "string",
            "metadata": {
                "description": "The Name for the Security Principal to assign NTFS permissions on the Azure File Share to support FSLogix.  Any value can be input in this field if performing a deployment update or choosing a personl host pool."
            },
            "defaultValue": "wvd_users"
        },
        "SessionHostCount": {
            "type": "int",
            "metadata": {
                "description": "Number of session hosts to deploy in the host pool"
            },
            "defaultValue": 2
        },
        "SessionHostIndex": {
            "type": "int",
            "metadata": {
                "description": "The session host number to begin with for the deployment. This is important when adding VM's to ensure the names do not conflict."
            },
            "defaultValue": 0
        },
        "StartVmOnConnect": {
            "type": "bool",
            "metadata": {
                "description": "Enable the 'Start VM On Connect' feature. https://docs.microsoft.com/en-us/azure/virtual-desktop/start-virtual-machine-connect"
            },
            "defaultValue": true
        },
        "StorageAccountName": {
            "type": "string",
            "metadata": {
                "description": "The Storage Account Name for the WVD user profile storage."
            },
            "defaultValue": "stjmwvdpoceus0"
        },
        "StorageAccountSku": {
            "type": "string",
            "metadata": {
                "description": "The Storage Account SKU for the WVD user profile storage."
            },
            "allowedValues": [
                "Standard_LRS",
                "Premium_LRS"
            ],
            "defaultValue": "Standard_LRS"
        },
        "Subnet": {
            "type": "string",
            "metadata": {
                "description": "Subnet for the WVD session hosts"
            },
            "defaultValue": "snet-clients-d-eastus"
        },
        "Tags": {
            "type": "object",
            "metadata": {
                "description": "Key / value pairs of metadata for the Azure resources."
            },
            "defaultValue": {
                "Owner": "Jason Masten",
                "Purpose": "POC",
                "Environment": "Development"
            }
        },
        "Timestamp": {
            "type": "string",
            "defaultValue": "[utcNow('yyyyMMddhhmmss')]"
        },
        "ValidationEnvironment": {
            "type": "bool",
            "metadata": {
                "description": "The value determines whether the hostpool should receive early WVD updates for testing."
            }
        },
        "VirtualNetwork": {
            "type": "string",
            "metadata": {
                "description": "Virtual network for the WVD sessions hosts"
            }
        },
        "VirtualNetworkResourceGroup": {
            "type": "string",
            "metadata": {
                "description": "Virtual network resource group for the WVD sessions hosts"
            }
        },
        "VmNamePrefix": {
            "type": "string",
            "metadata": {
                "description": "The Name Prefix for the Session Hosts.  During deployment a 3 digit number will be added to each Session Host to complete the name."
            }
        },
        "VmPassword": {
            "type": "securestring",
            "metadata": {
                "description": "Local administrator password for the WVD session hosts"
            }
        },
        "VmSize": {
            "type": "string",
            "metadata": {
                "description": "Virtual machine SKU"
            },
            "defaultValue": "Standard_B2s"
        },
        "VmUsername": {
            "type": "string",
            "metadata": {
                "description": "The Local Administrator Username for the Session Hosts"
            }
        },
        "WorkspaceName": {
            "type": "string",
            "metadata": {
                "description": "The name of the WVD workspace."
            }
        }
    },
    "variables": {
        "Netbios": "[split(parameters('DomainName'), '.')[0]]"
    },
    "resources": [
        {
            "comments": "---------- RESOURCE GROUPS ----------",
            "condition": "[equals(parameters('newOrExisting'), 'new')]",
            "name": "[parameters('ResourceGroups')[copyIndex()]]",
            "type": "Microsoft.Resources/resourceGroups",
            "apiVersion": "2019-10-01",
            "location": "[parameters('Location')]",
            "tags": "[parameters('Tags')]",
            "properties": {},
            "copy": {
                "name": "rgLoop",
                "count": "[length(parameters('ResourceGroups'))]"
            }
        },
        {
            "comments": "---------- CUSTOM ROLE > START VM ON CONNECT ----------",
            "condition": "[parameters('StartVmOnConnect')]",
            "name": "[guid(subscription().id, 'StartVmOnConnect')]",
            "type": "Microsoft.Authorization/roleDefinitions",
            "apiVersion": "2017-09-01",
            "properties": {
                "roleName": "StartVmOnConnect",
                "description": "Allow WVD session hosts to be started when needed.",
                "type": "customRole",
                "permissions": [
                    {
                        "actions": [
                            "Microsoft.Compute/virtualMachines/start/action",
                            "Microsoft.Compute/virtualMachines/read"
                        ],
                        "notActions": []
                    }
                ],
                "assignableScopes": [
                    "[subscription().id]"
                ]
            }
        },
        {
            "comments": "---------- ROLE ASSIGNMENT > WINDOWS VIRTUAL DESKTOP ----------",
            "condition": "[parameters('StartVmOnConnect')]",
            "type": "Microsoft.Authorization/roleAssignments",
            "apiVersion": "2017-09-01",
            "name": "[guid(subscription().id, 'WindowsVirtualDesktop')]",
            "dependsOn": [
                "[resourceId('Microsoft.Authorization/roleDefinitions', guid(subscription().id, 'StartVmOnConnect'))]"
            ],
            "properties": {
                "roleDefinitionId": "[resourceId('Microsoft.Authorization/roleDefinitions', guid(subscription().id, 'StartVmOnConnect'), '2017-09-01', 'Full').properties.principalId]",
                "principalId": "cdcfb416-e2fe-41e2-be12-33813c1cd427",
                "scope": "[subscription().id]"
            }
        },
        {
            "comments": "---------- LINKED DEPLOYMENT > WVD HOST POOL ----------",
            "type": "Microsoft.Resources/deployments",
            "apiVersion": "2019-10-01",
            "name": "[concat('HostPool_', parameters('Timestamp'))]",
            "tags": "[parameters('Tags')]",
            "resourceGroup": "[parameters('ResourceGroups')[0]]",
            "dependsOn": [
                "rgLoop"
            ],
            "properties": {
                "mode": "Incremental",
                "templateLink": {
                    "uri": "https://raw.githubusercontent.com/jamasten/Azure/master/solutions/wvd/templates/hostPool.json",
                    "contentVersion": "1.0.0.0"
                },
                "parameters": {
                    "AppGroupName": {
                        "value": "[parameters('AppGroupName')]"
                    },
                    "AppGroupType": {
                        "value": "[parameters('AppGroupType')]"
                    },
                    "CustomRdpProperty": {
                        "value": "[parameters('CustomRdpProperty')]"
                    },
                    "HostPoolName": {
                        "value": "[parameters('HostPoolName')]"
                    },
                    "HostPoolType": {
                        "value": "[parameters('HostPoolType')]"
                    },
                    "Location": {
                        "value": "[parameters('Location')]"
                    },
                    "MaxSessionLimit": {
                        "value": "[parameters('MaxSessionLimit')]"
                    },
                    "newOrExisting": {
                        "value": "[parameters('newOrExisting')]"
                    },
                    "PreferredAppGroupType": {
                        "value": "[parameters('PreferredAppGroupType')]"
                    },
                    "SecurityPrincipalId": {
                        "value": "[parameters('SecurityPrincipalId')]"
                    },
                    "StartVmOnConnect": {
                        "value": "[parameters('StartVmOnConnect')]"
                    },
                    "Tags": {
                        "value": "[parameters('Tags')]"
                    },
                    "ValidationEnvironment": {
                        "value": "[parameters('ValidationEnvironment')]"
                    },
                    "WorkspaceName": {
                        "value": "[parameters('WorkspaceName')]"
                    }
                }
            }
        },
        {
            "comments": "---------- LINKED DEPLOYMENT > WVD SESSION HOSTS ----------",
            "type": "Microsoft.Resources/deployments",
            "apiVersion": "2019-10-01",
            "name": "[concat('SessionHosts_', parameters('Timestamp'))]",
            "tags": "[parameters('Tags')]",
            "resourceGroup": "[parameters('ResourceGroups')[1]]",
            "dependsOn": [
                "rgLoop",
                "[concat('HostPool_', parameters('Timestamp'))]"
            ],
            "properties": {
                "mode": "Incremental",
                "templateLink": {
                    "uri": "https://raw.githubusercontent.com/jamasten/Azure/master/solutions/wvd/templates/sessionHosts.json",
                    "contentVersion": "1.0.0.0"
                },
                "parameters": {
                    "AvailabilitySetName": {
                        "value": "[parameters('AvailabilitySetName')]"
                    },
                    "DiskNamePrefix": {
                        "value": "[parameters('DiskNamePrefix')]"
                    },
                    "DiskSku": {
                        "value": "[parameters('DiskSku')]"
                    },
                    "DomainAdminPassword": {
                        "value": "[parameters('DomainAdminPassword')]"
                    },
                    "DomainAdminUsername": {
                        "value": "[parameters('DomainAdminUsername')]"
                    },
                    "DomainName": {
                        "value": "[parameters('DomainName')]"
                    },
                    "HostPoolName": {
                        "value": "[parameters('HostPoolName')]"
                    },
                    "HostPoolResourceGroupName": {
                        "value": "[parameters('ResourceGroups')[0]]"
                    },
                    "HostPoolType": {
                        "value": "[parameters('HostPoolType')]"
                    },
                    "ImageOffer": {
                        "value": "[parameters('ImageOffer')]"
                    },
                    "ImagePublisher": {
                        "value": "[parameters('ImagePublisher')]"
                    },
                    "ImageSku": {
                        "value": "[parameters('ImageSku')]"
                    },
                    "ImageVersion": {
                        "value": "[parameters('ImageVersion')]"
                    },
                    "Location": {
                        "value": "[parameters('Location')]"
                    },
                    "Netbios": {
                        "value": "[variables('Netbios')]"
                    },
                    "NicNamePrefix": {
                        "value": "[parameters('NicNamePrefix')]"
                    },
                    "Optimizations": {
                        "value": "[parameters('Optimizations')]"
                    },
                    "OuPath": {
                        "value": "[parameters('OuPath')]"
                    },
                    "SessionHostCount": {
                        "value": "[parameters('SessionHostCount')]"
                    },
                    "SessionHostIndex": {
                        "value": "[parameters('SessionHostIndex')]"
                    },
                    "StorageAccountName": {
                        "value": "[parameters('StorageAccountName')]"
                    },
                    "Subnet": {
                        "value": "[parameters('Subnet')]"
                    },
                    "Tags": {
                        "value": "[parameters('Tags')]"
                    },
                    "Timestamp": {
                        "value": "[parameters('Timestamp')]"
                    },
                    "VirtualNetwork": {
                        "value": "[parameters('VirtualNetwork')]"
                    },
                    "VirtualNetworkResourceGroup": {
                        "value": "[parameters('VirtualNetworkResourceGroup')]"
                    },
                    "VmNamePrefix": {
                        "value": "[parameters('VmNamePrefix')]"
                    },
                    "VmPassword": {
                        "value": "[parameters('VmPassword')]"
                    },
                    "VmSize": {
                        "value": "[parameters('VmSize')]"
                    },
                    "VmUsername": {
                        "value": "[parameters('VmUsername')]"
                    }
                }
            }
        },
        {
            "comments": "---------- LINKED DEPLOYMENT > FSLOGIX ----------",
            "condition": "[equals(split(parameters('HostPoolType'), ' ')[0], 'Pooled')]",
            "type": "Microsoft.Resources/deployments",
            "apiVersion": "2019-10-01",
            "name": "[concat('FSLogix_', parameters('Timestamp'))]",
            "tags": "[parameters('Tags')]",
            "resourceGroup": "[parameters('ResourceGroups')[0]]",
            "dependsOn": [
                "rgLoop",
                "[concat('HostPool_', parameters('Timestamp'))]"
            ],
            "properties": {
                "mode": "Incremental",
                "templateLink": {
                    "uri": "https://raw.githubusercontent.com/jamasten/Azure/master/solutions/wvd/templates/fslogix.json",
                    "contentVersion": "1.0.0.0"
                },
                "parameters": {
                    "DomainAdminPassword": {
                        "value": "[parameters('DomainAdminPassword')]"
                    },
                    "DomainAdminUsername": {
                        "value": "[parameters('DomainAdminUsername')]"
                    },
                    "DomainControllerName": {
                        "value": "[parameters('DomainControllerName')]"
                    },
                    "DomainControllerResourceGroupName": {
                        "value": "[parameters('DomainControllerResourceGroupName')]"
                    },
                    "DomainName": {
                        "value": "[parameters('DomainName')]"
                    },
                    "FileShareQuota": {
                        "value": "[parameters('FileShareQuota')]"
                    },
                    "HostPoolName": {
                        "value": "[parameters('HostPoolName')]"
                    },
                    "KerberosEncryptionType": {
                        "value": "[parameters('KerberosEncryptionType')]"
                    },
                    "Location": {
                        "value": "[parameters('Location')]"
                    },
                    "Netbios": {
                        "value": "[variables('Netbios')]"
                    },
                    "newOrExisting": {
                        "value": "[parameters('newOrExisting')]"
                    },
                    "SecurityPrincipalId": {
                        "value": "[parameters('SecurityPrincipalId')]"
                    },
                    "StorageAccountName": {
                        "value": "[parameters('StorageAccountName')]"
                    },
                    "StorageAccountSku": {
                        "value": "[parameters('StorageAccountSku')]"
                    },
                    "Tags": {
                        "value": "[parameters('Tags')]"
                    },
                    "Timestamp": {
                        "value": "[parameters('Timestamp')]"
                    }
                }
            }
        },
        {
            "comments": "---------- LINKED DEPLOYMENT > FILE SHARE NTFS PERMISSIONS ----------",
            "condition": "[equals(split(parameters('HostPoolType'), ' ')[0], 'Pooled')]",
            "type": "Microsoft.Resources/deployments",
            "apiVersion": "2019-10-01",
            "name": "[concat('FileSharePermissions_', parameters('Timestamp'))]",
            "tags": "[parameters('Tags')]",
            "resourceGroup": "[parameters('ResourceGroups')[1]]",
            "dependsOn": [
                "rgLoop",
                "[concat('HostPool_', parameters('Timestamp'))]",
                "[concat('SessionHosts_', parameters('Timestamp'))]",
                "[concat('FSLogix_', parameters('Timestamp'))]"
            ],
            "properties": {
                "mode": "Incremental",
                "templateLink": {
                    "uri": "https://raw.githubusercontent.com/jamasten/Azure/master/solutions/wvd/templates/fileSharePermissions.json",
                    "contentVersion": "1.0.0.0"
                },
                "parameters": {
                    "HostPoolName": {
                        "value": "[parameters('HostPoolName')]"
                    },
                    "Location": {
                        "value": "[parameters('Location')]"
                    },
                    "Netbios": {
                        "value": "[variables('Netbios')]"
                    },
                    "newOrExisting": {
                        "value": "[parameters('newOrExisting')]"
                    },
                    "SecurityPrincipalName": {
                        "value": "[parameters('SecurityPrincipalName')]"
                    },
                    "SessionHostIndex": {
                        "value": "[parameters('SessionHostIndex')]"
                    },
                    "StorageAccountName": {
                        "value": "[parameters('StorageAccountName')]"
                    },
                    "StorageAccountResourceGroupName": {
                        "value": "[parameters('ResourceGroups')[0]]"
                    },
                    "Tags": {
                        "value": "[parameters('Tags')]"
                    },
                    "Timestamp": {
                        "value": "[parameters('Timestamp')]"
                    },
                    "VmName": {
                        "value": "[parameters('VmNamePrefix')]"
                    }
                }
            }
        }
    ]
}