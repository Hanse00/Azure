{
    "$schema": "https://schema.management.azure.com/schemas/2018-05-01/subscriptionDeploymentTemplate.json#",
    "contentVersion": "1.0.0.0",
    "parameters": {
        "AppGroupName": {
            "type": "string",
            "metadata": {
                "description": "The name of the AVD application group."
            },
            "defaultValue": "Desktops"
        },
        "AppGroupType": {
            "type": "string",
            "metadata": {
                "description": "The type of AVD application group."
            },
            "allowedValues": [
                "Desktop",
                "RemoteApp"
            ],
            "defaultValue": "Desktop"
        },
        "AvailabilitySetName": {
            "type": "string",
            "metadata": {
                "description": "The name for the Availability Set for the AVD Session Hosts."
            },
            "defaultValue": "as-avd-poc-d-eus-000"
        },
        "CustomRdpProperty": {
            "type": "string",
            "metadata": {
                "description": "Input RDP properties to add or remove RDP functionality on the AVD host pool. Settings reference: https://docs.microsoft.com/en-us/windows-server/remote/remote-desktop-services/clients/rdp-files?context=/azure/virtual-desktop/context/context"
            },
            "defaultValue": "audiocapturemode:i:1;camerastoredirect:s:*;use multimon:i:0;drivestoredirect:s:;"
        },
        "DiskNamePrefix": {
            "type": "string",
            "metadata": {
                "description": "The name for the OS disk on the AVD session hosts."
            },
            "defaultValue": "disk-avd-poc-d-eus-"
        },
        "DiskSku": {
            "type": "string",
            "metadata": {
                "description": "The storage SKU for the AVD session host disks."
            },
            "allowedValues": [
                "Standard_LRS",
                "StandardSSD_LRS",
                "Premium_LRS"
            ],
            "defaultValue": "Premium_LRS"
        },
        "DomainAdminPassword": {
            "type": "securestring",
            "metadata": {
                "description": "The domain administrator password to join the AVD session hosts to your domain"
            }
        },
        "DomainAdminUsername": {
            "type": "string",
            "metadata": {
                "description": "The domain administrator username to join the AVD session hosts to your domain. Only the username is required. Do not add the Netbios value."
            }
        },
        "DomainControllerName": {
            "type": "string",
            "metadata": {
                "description": "The name of a Domain Controller in Azure for joining the Azure Storage Account to the domain."
            },
            "defaultValue": "vm-dc-d-eus-0"
        },
        "DomainControllerResourceGroupName": {
            "type": "string",
            "metadata": {
                "description": "The resource group name of a Domain Controller in Azure for joining the Azure Storage Account to the domain."
            },
            "defaultValue": "rg-identity-d-eastus"
        },
        "DomainName": {
            "type": "string",
            "metadata": {
                "description": "The name of the domain that provides ADDS to the AVD session hosts and is synchronized with Azure AD"
            },
            "defaultValue": "jasonmasten.com"
        },
        "FileShareQuota": {
            "type": "int",
            "metadata": {
                "description": "The file share quota for the file share on the Azure Storage Account."
            },
            "defaultValue": 100
        },
        "HostPoolName": {
            "type": "string",
            "metadata": {
                "description": "The name for the AVD Host Pool."
            },
            "defaultValue": "hp-avd-poc-d-eus-000"
        },
        "HostPoolType": {
            "type": "string",
            "metadata": {
                "description": "These options specify the host pool type and depending on the type, provides the load balancing options and assignment types."
            },
            "allowedValues": [
                "Pooled DepthFirst",
                "Pooled BreadthFirst",
                "Personal Automatic",
                "Personal Direct"
            ],
            "defaultValue": "Pooled DepthFirst"
        },
        "ImageOffer": {
            "type": "string",
            "metadata": {
                "description": "Offer for the virtual machine image"
            },
            "defaultValue": "office-365"
        },
        "ImagePublisher": {
            "type": "string",
            "metadata": {
                "description": "Publisher for the virtual machine image"
            },
            "defaultValue": "MicrosoftWindowsDesktop"
        },
        "ImageSku": {
            "type": "string",
            "metadata": {
                "description": "SKU for the virtual machine image"
            },
            "defaultValue": "20h2-evd-o365pp"
        },
        "ImageVersion": {
            "type": "string",
            "metadata": {
                "description": "Version for the virtual machine image"
            },
            "defaultValue": "latest"
        },
        "InstallTeams": {
            "type": "bool",
            "metadata": {
                "description": "Install Microsoft Teams with Media Optimization for VDI."
            }
        },
        "KerberosEncryptionType": {
            "type": "string",
            "metadata": {
                "description": "The Active Directory computer object Kerberos encryption type for the Azure Storage Account."
            },
            "allowedValues": [
                "RC4",
                "AES256"
            ],
            "defaultValue": "RC4"
        },
        "Location": {
            "type": "string",
            "metadata": {
                "description": "The deployment location for all the resources in this template."
            },
            "defaultValue": "[deployment().location]"
        },
        "LogAnalyticsWorkspaceName": {
            "type": "string",
            "metadata": {
                "description": "The name for the Log Analytics Workspace to setup the AVD Monitoring solution"
            },
            "defaultValue": "law-avd-poc-d-eus-000"
        },
        "LogAnalyticsWorkspaceRetention": {
            "type": "int",
            "metadata": {
                "description": "The retention for the Log Analytics Workspace to setup the AVD Monitoring solution"
            },
            "defaultValue": 30,
            "maxValue": 730,
            "minValue": 30
        },
        "LogAnalyticsWorkspaceSku": {
            "type": "string",
            "metadata": {
                "description": "The SKU for the Log Analytics Workspace to setup the AVD Monitoring solution"
            },
            "defaultValue": "PerGB2018",
            "allowedValues": [
                "Free",
                "Standard",
                "Premium",
                "PerNode",
                "PerGB2018",
                "Standalone",
                "CapacityReservation"
            ]
        },
        "MaxSessionLimit": {
            "type": "int",
            "metadata": {
                "description": "The maximum number of sessions per AVD session host."
            },
            "defaultValue": 2
        },
        "newOrExisting": {
            "type": "string",
            "allowedValues": [
                "new",
                "existing"
            ]
        },
        "NicNamePrefix": {
            "type": "string",
            "metadata": {
                "description": "The name prefix for the Network Interfaces on the Session Hosts.  During deployment a 3 digit number will be added to each NIC to complete the name."
            },
            "defaultValue": "nic-avd-poc-d-eus-"
        },
        "Optimizations": {
            "type": "string",
            "metadata": {
                "description": "The AVD optimizations to implement on the Session Hosts using the optimization script. Input a string array with any of the following values: 'All','WindowsMediaPlayer','AppxPackages','ScheduledTasks','DefaultUserSettings','Autologgers','Services','NetworkOptimizations','LGPO','DiskCleanup'"
            },
            "defaultValue": "All"
        },
        "OuPath": {
            "type": "string",
            "metadata": {
                "description": "The distinguished name for the target Organization Unit in Active Directory Domain Services."
            },
            "defaultValue": "OU=Pooled,OU=AVD,DC=jasonmasten,DC=com"
        },
        "PreferredAppGroupType": {
            "type": "string",
            "metadata": {
                "description": "The type of preferred application group type.  The default is Desktop which creates 'Desktop Application Group'"
            },
            "allowedValues": [
                "Desktop",
                "RailApplications"
            ],
            "defaultValue": "Desktop"
        },
        "ResourceGroups": {
            "type": "array",
            "metadata": {
                "description": "The names of the resource groups for the AVD Host Pool and Session Hosts.  The first resource group will be dedicated to the AVD infrastructure.  The second resource group will be dedicated to the AVD session hosts."
            },
            "defaultValue": [
                "rg-avd-poc-infra-d-eus-000",
                "rg-avd-poc-hosts-d-eus-000"
            ]
        },
        "SecurityPrincipalId": {
            "type": "string",
            "metadata": {
                "description": "The Object ID for the Security Principal to assign to the AVD Application Group.  This Security Principal will be assigned the Desktop Virtualization User role on the Application Group."
            },
            "defaultValue": "5c55bf93-86ee-4e1d-a81a-3a78402e6077"
        },
        "SecurityPrincipalName": {
            "type": "string",
            "metadata": {
                "description": "The name for the Security Principal to assign NTFS permissions on the Azure File Share to support FSLogix.  Any value can be input in this field if performing a deployment update or choosing a personal host pool."
            },
            "defaultValue": "avd_users"
        },
        "SessionHostCount": {
            "type": "int",
            "metadata": {
                "description": "The number of session hosts to deploy in the host pool"
            },
            "defaultValue": 2
        },
        "SessionHostIndex": {
            "type": "int",
            "metadata": {
                "description": "The session host number to begin with for the deployment. This is important when adding VM's to ensure the names do not conflict."
            },
            "defaultValue": 0
        },
        "StartVmOnConnect": {
            "type": "bool",
            "metadata": {
                "description": "Enable the 'Start VM On Connect' feature. https://docs.microsoft.com/en-us/azure/virtual-desktop/start-virtual-machine-connect"
            },
            "defaultValue": true
        },
        "StorageAccountName": {
            "type": "string",
            "metadata": {
                "description": "The name for the Azure storage account containing the AVD user profile data."
            },
            "defaultValue": "stjmavdpocdeus0"
        },
        "StorageAccountSku": {
            "type": "string",
            "metadata": {
                "description": "The SKU for the Azure storage account containing the AVD user profile data."
            },
            "allowedValues": [
                "Standard_LRS",
                "Premium_LRS"
            ],
            "defaultValue": "Standard_LRS"
        },
        "Subnet": {
            "type": "string",
            "metadata": {
                "description": "The subnet for the AVD session hosts."
            },
            "defaultValue": "snet-clients-d-eastus"
        },
        "Tags": {
            "type": "object",
            "metadata": {
                "description": "Key / value pairs of metadata for the Azure resources."
            },
            "defaultValue": {
                "Owner": "Jason Masten",
                "Purpose": "POC",
                "Environment": "Development"
            }
        },
        "Timestamp": {
            "type": "string",
            "defaultValue": "[utcNow('yyyyMMddhhmmss')]"
        },
        "ValidationEnvironment": {
            "type": "bool",
            "metadata": {
                "description": "The value determines whether the hostpool should receive early AVD updates for testing."
            },
            "defaultValue": false
        },
        "VirtualNetwork": {
            "type": "string",
            "metadata": {
                "description": "Virtual network for the AVD sessions hosts"
            },
            "defaultValue": "vnet-d-eastus"
        },
        "VirtualNetworkResourceGroup": {
            "type": "string",
            "metadata": {
                "description": "Virtual network resource group for the AVD sessions hosts"
            },
            "defaultValue": "rg-network-d-eastus"
        },
        "VmNamePrefix": {
            "type": "string",
            "metadata": {
                "description": "The name prefix for the AVD session hosts.  During deployment a 3 digit number will be added to each session host to complete the name."
            },
            "defaultValue": "vmavdpocdeus"
        },
        "VmPassword": {
            "type": "securestring",
            "metadata": {
                "description": "Local administrator password for the AVD session hosts"
            }
        },
        "VmSize": {
            "type": "string",
            "metadata": {
                "description": "The VM SKU for the AVD session hosts."
            },
            "defaultValue": "Standard_B2s"
        },
        "VmUsername": {
            "type": "string",
            "metadata": {
                "description": "The Local Administrator Username for the Session Hosts"
            }
        },
        "WorkspaceName": {
            "type": "string",
            "metadata": {
                "description": "The name of the AVD workspace."
            },
            "defaultValue": "ws-avd-poc-d-eus-000"
        },
        "WvdObjectId": {
            "type": "string",
            "metadata": {
                "description": "The Object ID for the 'Windows Virtual Desktop' Enterprise Application in Azure AD.  The Object ID can found by selecting 'Microsoft Applications' using the 'Application type' filter in the Enterprise Applications blade of Azure AD."
            }
        }
    },
    "variables": {
        "Netbios": "[split(parameters('DomainName'), '.')[0]]",
        "RoleAssignmentName": "[guid(subscription().id, 'WindowsVirtualDesktop')]",
        "RoleDefinitionName": "[guid(subscription().id, 'StartVmOnConnect')]"
    },
    "resources": [
        {
            "comments": "---------- RESOURCE GROUPS ----------",
            "condition": "[equals(parameters('newOrExisting'), 'new')]",
            "name": "[parameters('ResourceGroups')[copyIndex()]]",
            "type": "Microsoft.Resources/resourceGroups",
            "apiVersion": "2019-10-01",
            "location": "[parameters('Location')]",
            "tags": "[parameters('Tags')]",
            "properties": {},
            "copy": {
                "name": "rgLoop",
                "count": "[length(parameters('ResourceGroups'))]"
            }
        },
        {
            "comments": "---------- CUSTOM ROLE > START VM ON CONNECT ----------",
            "condition": "[parameters('StartVmOnConnect')]",
            "name": "[variables('RoleDefinitionName')]",
            "type": "Microsoft.Authorization/roleDefinitions",
            "apiVersion": "2017-09-01",
            "properties": {
                "roleName": "StartVmOnConnect",
                "description": "Allow AVD session hosts to be started when needed.",
                "type": "customRole",
                "permissions": [
                    {
                        "actions": [
                            "Microsoft.Compute/virtualMachines/start/action",
                            "Microsoft.Compute/virtualMachines/read"
                        ],
                        "notActions": []
                    }
                ],
                "assignableScopes": [
                    "[subscription().id]"
                ]
            }
        },
        {
            "comments": "---------- ROLE ASSIGNMENT > WINDOWS VIRTUAL DESKTOP ----------",
            "condition": "[parameters('StartVmOnConnect')]",
            "type": "Microsoft.Authorization/roleAssignments",
            "apiVersion": "2017-09-01",
            "name": "[variables('RoleAssignmentName')]",
            "dependsOn": [
                "[resourceId('Microsoft.Authorization/roleDefinitions', variables('RoleDefinitionName'))]"
            ],
            "properties": {
                "roleDefinitionId": "[resourceId('Microsoft.Authorization/roleDefinitions', variables('RoleDefinitionName'))]",
                "principalId": "[parameters('WvdObjectId')]",
                "scope": "[subscription().id]"
            }
        },
        {
            "comments": "---------- LINKED DEPLOYMENT > AVD HOST POOL ----------",
            "type": "Microsoft.Resources/deployments",
            "apiVersion": "2019-10-01",
            "name": "[concat('HostPool_', parameters('Timestamp'))]",
            "tags": "[parameters('Tags')]",
            "resourceGroup": "[parameters('ResourceGroups')[0]]",
            "dependsOn": [
                "rgLoop"
            ],
            "properties": {
                "mode": "Incremental",
                "templateLink": {
                    "uri": "https://raw.githubusercontent.com/jamasten/Azure/master/solutions/avd/templates/hostPool.json",
                    "contentVersion": "1.0.0.0"
                },
                "parameters": {
                    "AppGroupName": {
                        "value": "[parameters('AppGroupName')]"
                    },
                    "AppGroupType": {
                        "value": "[parameters('AppGroupType')]"
                    },
                    "CustomRdpProperty": {
                        "value": "[parameters('CustomRdpProperty')]"
                    },
                    "HostPoolName": {
                        "value": "[parameters('HostPoolName')]"
                    },
                    "HostPoolType": {
                        "value": "[parameters('HostPoolType')]"
                    },
                    "LogAnalyticsWorkspaceName": {
                        "value": "[parameters('LogAnalyticsWorkspaceName')]"
                    },
                    "LogAnalyticsWorkspaceRetention": {
                        "value": "[parameters('LogAnalyticsWorkspaceRetention')]"
                    },
                    "LogAnalyticsWorkspaceSku": {
                        "value": "[parameters('LogAnalyticsWorkspaceSku')]"
                    },
                    "Location": {
                        "value": "[parameters('Location')]"
                    },
                    "MaxSessionLimit": {
                        "value": "[parameters('MaxSessionLimit')]"
                    },
                    "newOrExisting": {
                        "value": "[parameters('newOrExisting')]"
                    },
                    "PreferredAppGroupType": {
                        "value": "[parameters('PreferredAppGroupType')]"
                    },
                    "SecurityPrincipalId": {
                        "value": "[parameters('SecurityPrincipalId')]"
                    },
                    "StartVmOnConnect": {
                        "value": "[parameters('StartVmOnConnect')]"
                    },
                    "Tags": {
                        "value": "[parameters('Tags')]"
                    },
                    "ValidationEnvironment": {
                        "value": "[parameters('ValidationEnvironment')]"
                    },
                    "WorkspaceName": {
                        "value": "[parameters('WorkspaceName')]"
                    }
                }
            }
        },
        {
            "comments": "---------- LINKED DEPLOYMENT > AVD SESSION HOSTS ----------",
            "type": "Microsoft.Resources/deployments",
            "apiVersion": "2019-10-01",
            "name": "[concat('SessionHosts_', parameters('Timestamp'))]",
            "tags": "[parameters('Tags')]",
            "resourceGroup": "[parameters('ResourceGroups')[1]]",
            "dependsOn": [
                "rgLoop",
                "[concat('HostPool_', parameters('Timestamp'))]"
            ],
            "properties": {
                "mode": "Incremental",
                "templateLink": {
                    "uri": "https://raw.githubusercontent.com/jamasten/Azure/master/solutions/avd/templates/sessionHosts.json",
                    "contentVersion": "1.0.0.0"
                },
                "parameters": {
                    "AvailabilitySetName": {
                        "value": "[parameters('AvailabilitySetName')]"
                    },
                    "DiskNamePrefix": {
                        "value": "[parameters('DiskNamePrefix')]"
                    },
                    "DiskSku": {
                        "value": "[parameters('DiskSku')]"
                    },
                    "DomainAdminPassword": {
                        "value": "[parameters('DomainAdminPassword')]"
                    },
                    "DomainAdminUsername": {
                        "value": "[parameters('DomainAdminUsername')]"
                    },
                    "DomainName": {
                        "value": "[parameters('DomainName')]"
                    },
                    "HostPoolName": {
                        "value": "[parameters('HostPoolName')]"
                    },
                    "HostPoolResourceGroupName": {
                        "value": "[parameters('ResourceGroups')[0]]"
                    },
                    "HostPoolType": {
                        "value": "[parameters('HostPoolType')]"
                    },
                    "ImageOffer": {
                        "value": "[parameters('ImageOffer')]"
                    },
                    "ImagePublisher": {
                        "value": "[parameters('ImagePublisher')]"
                    },
                    "ImageSku": {
                        "value": "[parameters('ImageSku')]"
                    },
                    "ImageVersion": {
                        "value": "[parameters('ImageVersion')]"
                    },
                    "InstallTeams": {
                        "value": "[parameters('InstallTeams')]"
                    },
                    "Location": {
                        "value": "[parameters('Location')]"
                    },
                    "LogAnalyticsWorkspaceName": {
                        "value": "[parameters('LogAnalyticsWorkspaceName')]"
                    },
                    "LogAnalyticsWorkspaceResourceGroupName": {
                        "value": "[parameters('ResourceGroups')[0]]"
                    },
                    "Netbios": {
                        "value": "[variables('Netbios')]"
                    },
                    "NicNamePrefix": {
                        "value": "[parameters('NicNamePrefix')]"
                    },
                    "Optimizations": {
                        "value": "[parameters('Optimizations')]"
                    },
                    "OuPath": {
                        "value": "[parameters('OuPath')]"
                    },
                    "SessionHostCount": {
                        "value": "[parameters('SessionHostCount')]"
                    },
                    "SessionHostIndex": {
                        "value": "[parameters('SessionHostIndex')]"
                    },
                    "StorageAccountName": {
                        "value": "[parameters('StorageAccountName')]"
                    },
                    "Subnet": {
                        "value": "[parameters('Subnet')]"
                    },
                    "Tags": {
                        "value": "[parameters('Tags')]"
                    },
                    "Timestamp": {
                        "value": "[parameters('Timestamp')]"
                    },
                    "VirtualNetwork": {
                        "value": "[parameters('VirtualNetwork')]"
                    },
                    "VirtualNetworkResourceGroup": {
                        "value": "[parameters('VirtualNetworkResourceGroup')]"
                    },
                    "VmNamePrefix": {
                        "value": "[parameters('VmNamePrefix')]"
                    },
                    "VmPassword": {
                        "value": "[parameters('VmPassword')]"
                    },
                    "VmSize": {
                        "value": "[parameters('VmSize')]"
                    },
                    "VmUsername": {
                        "value": "[parameters('VmUsername')]"
                    }
                }
            }
        },
        {
            "comments": "---------- LINKED DEPLOYMENT > FSLOGIX ----------",
            "condition": "[equals(split(parameters('HostPoolType'), ' ')[0], 'Pooled')]",
            "type": "Microsoft.Resources/deployments",
            "apiVersion": "2019-10-01",
            "name": "[concat('FSLogix_', parameters('Timestamp'))]",
            "tags": "[parameters('Tags')]",
            "resourceGroup": "[parameters('ResourceGroups')[0]]",
            "dependsOn": [
                "rgLoop",
                "[concat('HostPool_', parameters('Timestamp'))]"
            ],
            "properties": {
                "mode": "Incremental",
                "templateLink": {
                    "uri": "https://raw.githubusercontent.com/jamasten/Azure/master/solutions/avd/templates/fslogix.json",
                    "contentVersion": "1.0.0.0"
                },
                "parameters": {
                    "DomainAdminPassword": {
                        "value": "[parameters('DomainAdminPassword')]"
                    },
                    "DomainAdminUsername": {
                        "value": "[parameters('DomainAdminUsername')]"
                    },
                    "DomainControllerName": {
                        "value": "[parameters('DomainControllerName')]"
                    },
                    "DomainControllerResourceGroupName": {
                        "value": "[parameters('DomainControllerResourceGroupName')]"
                    },
                    "DomainName": {
                        "value": "[parameters('DomainName')]"
                    },
                    "FileShareQuota": {
                        "value": "[parameters('FileShareQuota')]"
                    },
                    "HostPoolName": {
                        "value": "[parameters('HostPoolName')]"
                    },
                    "KerberosEncryptionType": {
                        "value": "[parameters('KerberosEncryptionType')]"
                    },
                    "Location": {
                        "value": "[parameters('Location')]"
                    },
                    "Netbios": {
                        "value": "[variables('Netbios')]"
                    },
                    "newOrExisting": {
                        "value": "[parameters('newOrExisting')]"
                    },
                    "SecurityPrincipalId": {
                        "value": "[parameters('SecurityPrincipalId')]"
                    },
                    "StorageAccountName": {
                        "value": "[parameters('StorageAccountName')]"
                    },
                    "StorageAccountSku": {
                        "value": "[parameters('StorageAccountSku')]"
                    },
                    "Tags": {
                        "value": "[parameters('Tags')]"
                    },
                    "Timestamp": {
                        "value": "[parameters('Timestamp')]"
                    }
                }
            }
        },
        {
            "comments": "---------- LINKED DEPLOYMENT > FILE SHARE NTFS PERMISSIONS ----------",
            "condition": "[equals(split(parameters('HostPoolType'), ' ')[0], 'Pooled')]",
            "type": "Microsoft.Resources/deployments",
            "apiVersion": "2019-10-01",
            "name": "[concat('FileSharePermissions_', parameters('Timestamp'))]",
            "tags": "[parameters('Tags')]",
            "resourceGroup": "[parameters('ResourceGroups')[1]]",
            "dependsOn": [
                "rgLoop",
                "[concat('HostPool_', parameters('Timestamp'))]",
                "[concat('SessionHosts_', parameters('Timestamp'))]",
                "[concat('FSLogix_', parameters('Timestamp'))]"
            ],
            "properties": {
                "mode": "Incremental",
                "templateLink": {
                    "uri": "https://raw.githubusercontent.com/jamasten/Azure/master/solutions/avd/templates/fileSharePermissions.json",
                    "contentVersion": "1.0.0.0"
                },
                "parameters": {
                    "HostPoolName": {
                        "value": "[parameters('HostPoolName')]"
                    },
                    "Location": {
                        "value": "[parameters('Location')]"
                    },
                    "Netbios": {
                        "value": "[variables('Netbios')]"
                    },
                    "newOrExisting": {
                        "value": "[parameters('newOrExisting')]"
                    },
                    "SecurityPrincipalName": {
                        "value": "[parameters('SecurityPrincipalName')]"
                    },
                    "SessionHostIndex": {
                        "value": "[parameters('SessionHostIndex')]"
                    },
                    "StorageAccountName": {
                        "value": "[parameters('StorageAccountName')]"
                    },
                    "StorageAccountResourceGroupName": {
                        "value": "[parameters('ResourceGroups')[0]]"
                    },
                    "Tags": {
                        "value": "[parameters('Tags')]"
                    },
                    "Timestamp": {
                        "value": "[parameters('Timestamp')]"
                    },
                    "VmName": {
                        "value": "[parameters('VmNamePrefix')]"
                    }
                }
            }
        }
    ]
}